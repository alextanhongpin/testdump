# pgdump
[![Go Reference](https://pkg.go.dev/badge/github.com/alextanhongpin/testdump/pgdump.svg)](https://pkg.go.dev/github.com/alextanhongpin/testdump/pgdump)

## Purpose

`pgdump` and its cousin `mysqldump` allow you to perform snapshot testing for SQL queries. The library helps you verify that SQL queries generated by your application match your expectations, especially when using ORMs or migrating between different database access methods.

The main goal is to catch SQL query changes during development and testing before they cause issues in production.

## How It Works

It dumps the query string with the arguments extracted, and displays the diff whenever there are changes. This makes it easy to spot unexpected SQL changes in your test output.

## Example Usage

### Basic Usage

```go
func TestBasicDump(t *testing.T) {
    dump := &pgdump.SQL{
        Query: `SELECT * FROM users WHERE name = $1 AND age = $2`,
        Args:  []any{"John", 13},
    }

    pgdump.Dump(t, dump)
}
```

### Ignoring Dynamic Arguments

```go
func TestWithTimeValue(t *testing.T) {
    dump := &pgdump.SQL{
        Query: `SELECT * FROM users WHERE created_at > $1`,
        Args:  []any{time.Now()},
    }

    // Ignore timestamp parameter that changes between test runs
    pgdump.Dump(t, dump, pgdump.IgnoreArgs("$1"))
}
```

### Using Transformers

```go
func TestWithPrettify(t *testing.T) {
    dump := &pgdump.SQL{
        Query: `SELECT * FROM users WHERE id = $1`,
        Args:  []any{1},
    }

    // Create a custom dumper with pretty printing
    pd := pgdump.New(pgdump.Prettify)
    pd.Dump(t, dump)
}
```

### Recording Multiple Queries

```go
func TestRecording(t *testing.T) {
    recorder := pgdump.NewRecorder()
    
    // Execute your database operations...
    
    // Dump all recorded queries
    recorder.Dump(t)
}
```

## Benefits

- **Stability**: Catches unexpected SQL query changes during testing to prevent runtime errors.
- **Migration Safety**: Simplifies migration between different ORMs or switching to raw SQL by ensuring query equivalence.
- **Improved Observability**: See exactly what SQL is being generated by your application code.
- **Format Flexibility**: Intelligently compares queries regardless of formatting differences (case, whitespace, quoting).
- **Debugging Aid**: Generated snapshots can be copied directly into database clients for manual investigation.
- **Documentation**: SQL snapshots serve as documentation for the expected database interaction patterns.

Using `pgdump.NewRecorder`, you can generate snapshots of all the executed SQL in a run, making it easy to trace and debug complex database operations.
